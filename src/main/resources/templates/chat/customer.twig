{% extends "../_master.twig" %}
{# using master template #}


{% block title %}Customer Chat : {{ thread_title }} {%endblock%}


{% block content %}

    <br /><br />

    <div class="row" id="chatContainer">

        <div id="chatPanel" class="panel panel-default text-center">
            <div class="panel-heading">
                <h1 class="panel-title">{{ thread_title }}</h1>
            </div>
            <div class="panel-body" style="text-align: left;" id="chatPanelBody">


                <div class="row">
                    <div class="col-md-6">
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="connect">WebSocket connection:</label>
                                <button id="connect" class="btn btn-default" type="button">Connect</button>
                                <button id="disconnect" class="btn btn-default" type="button" disabled="disabled">Disconnect
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="name">What is your name?</label>
                                <input type="text" id="name" class="form-control" placeholder="Your name here...">
                            </div>
                            <button id="send" class="btn btn-default" type="button">Send</button>
                        </form>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <table id="conversation" class="table table-striped">
                            <thead>
                            <tr>
                                <th>Greetings</th>
                            </tr>
                            </thead>
                            <tbody id="greetings">
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>
        </div>


    </div>

{% endblock %}


{% block extra_js %}

<script src="https://cdn.jsdelivr.net/sockjs/1.1.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script type="application/javascript">

	var stompClient = null;

	function setConnected(connected) {
		$("#connect").prop("disabled", connected);
		$("#disconnect").prop("disabled", !connected);
		if (connected) {
			$("#conversation").show();
		}
		else {
			$("#conversation").hide();
		}
		$("#greetings").html("");
	}

	//conects to our websocket
	function connect() {
		var socket = new SockJS("/ws");
		stompClient = Stomp.over(socket);
		stompClient.connect({}, function (frame) {
			setConnected(true);

			console.log('Connected: ' + frame);

			stompClient.subscribe('/topic/greetings', function ( serverMessage ) {

				//parse message coming from server
				var decodedMessage = jQuery.parseJSON( serverMessage.body );
				showGreeting( "test" );
			});
		});
	}

	function disconnect() {
		if (stompClient != null) {
			stompClient.disconnect();
		}
		setConnected(false);
		console.log("Disconnected");
	}

	function sendName() {
		stompClient.send("/helloworld", {}, JSON.stringify({'name': $("#name").val()}));
	}

	function showGreeting(message) {
		$("#greetings").append("<tr><td>" + message.message + "</td></tr>");
	}

	$(function () {
		$("form").on('submit', function (e) {
			e.preventDefault();
		});
		$( "#connect" ).click(function() { connect(); });
		$( "#disconnect" ).click(function() { disconnect(); });
		$( "#send" ).click(function() { sendName(); });
	});

</script>

{% endblock %}